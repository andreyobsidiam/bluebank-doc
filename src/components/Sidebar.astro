---
import { getCollection } from "astro:content";

const docs = await getCollection("docs");
const sortedDocs = docs.sort(
  (a, b) => (a.data.order || 99) - (b.data.order || 99)
);

const currentPath = Astro.url.pathname;

// Detect current section from path
const getCurrentSection = () => {
  if (currentPath.includes("/docs/mobile/")) return "mobile";
  if (currentPath.includes("/docs/web/")) return "web";
  if (currentPath.includes("/docs/api/")) return "api";
  return null;
};
const currentSection = getCurrentSection();

// Group docs by section
const docsBySection = {
  mobile: sortedDocs.filter((d) => d.data.section === "mobile"),
  web: sortedDocs.filter((d) => d.data.section === "web"),
  api: sortedDocs.filter((d) => d.data.section === "api" || !d.data.section),
};

const sections = [
  {
    id: "home",
    title: "Inicio",
    icon: "ðŸ ",
    links: [{ title: "Bienvenido", slug: "", icon: "ðŸ‘‹" }],
    collapsible: false,
  },
  {
    id: "mobile",
    title: "Mobile",
    icon: "ðŸ“±",
    color: "pink",
    collapsible: true,
    links: docsBySection.mobile.map((doc) => ({
      title: doc.data.title,
      slug: doc.slug,
      icon: doc.data.icon || "ðŸ“„",
    })),
  },
  {
    id: "web",
    title: "Web",
    icon: "ðŸŒ",
    color: "cyan",
    collapsible: true,
    links: docsBySection.web.map((doc) => ({
      title: doc.data.title,
      slug: doc.slug,
      icon: doc.data.icon || "ðŸ“„",
    })),
  },
  {
    id: "api",
    title: "API (Supabase)",
    icon: "âš¡",
    color: "emerald",
    collapsible: true,
    links: docsBySection.api.map((doc) => ({
      title: doc.data.title,
      slug: doc.slug,
      icon: doc.data.icon || "ðŸ“„",
    })),
  },
];
---

<!-- Overlay / Backdrop -->
<div
  id="sidebar-overlay"
  class="fixed inset-0 bg-slate-950/60 backdrop-blur-sm z-40 hidden lg:hidden transition-opacity duration-300 opacity-0"
>
</div>

<aside
  id="sidebar"
  class="fixed left-0 top-0 bottom-0 w-72 bg-slate-900/80 backdrop-blur-xl border-r border-slate-700/50 flex flex-col z-50 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out"
>
  <!-- Logo & Close Button -->
  <div
    class="p-6 border-b border-slate-700/50 flex items-center justify-between"
  >
    <a href="/" class="flex items-center gap-3 group">
      <img src="/logo_blue.png" alt="Blue Bank Logo" class="h-10 w-auto" />
    </a>
    <button
      id="close-sidebar"
      class="lg:hidden p-2 text-gray-400 hover:text-white hover:bg-slate-800 rounded-lg transition-colors"
      aria-label="Cerrar menÃº"
    >
      <svg
        class="w-6 h-6"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Navigation -->
  <nav class="flex-1 overflow-y-auto py-6 px-4">
    {
      sections.map((section) => (
        <div class="mb-4">
          {section.collapsible ? (
            <button
              class:list={[
                "collapsible-btn w-full flex items-center justify-between gap-2 px-4 py-2 text-xs font-semibold uppercase tracking-wider transition-colors rounded-lg",
                currentSection === section.id
                  ? "section-active"
                  : "text-gray-400 hover:text-white hover:bg-slate-800/50",
              ]}
              data-section={section.id}
              data-color={section.color}
            >
              <span class="flex items-center gap-2">
                <span>{section.icon}</span>
                {section.title}
              </span>
              <svg
                class="chevron w-4 h-4 transition-transform duration-200"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>
          ) : (
            <h3 class="flex items-center gap-2 px-4 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-3">
              <span>{section.icon}</span>
              {section.title}
            </h3>
          )}
          <ul
            class:list={[
              "space-y-1 mt-2 overflow-hidden transition-all duration-300",
              {
                "collapsible-content": section.collapsible,
                "max-h-0": section.collapsible,
              },
            ]}
            data-section-content={section.id}
          >
            {section.links.map((link) => {
              const href = link.slug === "" ? "/" : `/docs/${link.slug}`;
              const isActive =
                currentPath === href ||
                (currentPath === "/" && link.slug === "");
              return (
                <li>
                  <a
                    href={href}
                    class:list={["sidebar-link", { active: isActive }]}
                  >
                    <span class="text-lg">{link.icon}</span>
                    <span class="font-medium text-sm">{link.title}</span>
                  </a>
                </li>
              );
            })}
          </ul>
        </div>
      ))
    }
  </nav>

  <!-- Footer -->
  <div class="p-4 border-t border-slate-700/50">
    <div class="glass-card p-4 text-center">
      <p class="text-xs text-gray-400">Blue Bank Docs</p>
      <p class="text-sm font-semibold text-bluebank-400">v1.0.0</p>
    </div>
  </div>
</aside>

<style>
  .collapsible-content {
    max-height: 0;
  }

  .collapsible-content.expanded {
    max-height: 500px;
  }

  .collapsible-btn .chevron {
    transform: rotate(-90deg);
  }

  .collapsible-btn.expanded .chevron {
    transform: rotate(0deg);
  }

  /* Active section styles */
  .section-active {
    color: white;
    border-left: 3px solid;
  }

  .section-active[data-color="pink"] {
    background-color: rgba(236, 72, 153, 0.2);
    border-color: rgb(236, 72, 153);
  }

  .section-active[data-color="cyan"] {
    background-color: rgba(6, 182, 212, 0.2);
    border-color: rgb(6, 182, 212);
  }

  .section-active[data-color="emerald"] {
    background-color: rgba(16, 185, 129, 0.2);
    border-color: rgb(16, 185, 129);
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const sidebar = document.getElementById("sidebar");
    const overlay = document.getElementById("sidebar-overlay");
    const closeBtn = document.getElementById("close-sidebar");
    const openBtn = document.getElementById("open-sidebar"); // This will be in Header.astro

    const toggleSidebar = (show: boolean) => {
      if (show) {
        sidebar?.classList.remove("-translate-x-full");
        overlay?.classList.remove("hidden");
        setTimeout(() => overlay?.classList.add("opacity-100"), 10);
        document.body.style.overflow = "hidden";
      } else {
        sidebar?.classList.add("-translate-x-full");
        overlay?.classList.remove("opacity-100");
        setTimeout(() => overlay?.classList.add("hidden"), 300);
        document.body.style.overflow = "";
      }
    };

    openBtn?.addEventListener("click", () => toggleSidebar(true));
    closeBtn?.addEventListener("click", () => toggleSidebar(false));
    overlay?.addEventListener("click", () => toggleSidebar(false));

    // Handle ESC key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") toggleSidebar(false);
    });

    const buttons = document.querySelectorAll(".collapsible-btn");
    const storageKey = "bluebank-docs-sections";

    // Load saved state from localStorage
    const savedState = JSON.parse(localStorage.getItem(storageKey) || "{}");

    // Check if current page is in any section and expand that section
    const currentPath = window.location.pathname;

    buttons.forEach((btn) => {
      const sectionId = btn.getAttribute("data-section") || "";
      const content = document.querySelector(
        `[data-section-content="${sectionId}"]`
      );

      if (!content) return;

      // Check if current page is in this section
      const links = content.querySelectorAll("a");
      let isCurrentSection = false;
      links.forEach((link) => {
        if (link.getAttribute("href") === currentPath) {
          isCurrentSection = true;
        }
      });

      // Expand if current section or saved as expanded
      if (isCurrentSection || savedState[sectionId]) {
        btn.classList.add("expanded");
        content.classList.add("expanded");
        savedState[sectionId] = true;
      }

      btn.addEventListener("click", () => {
        const isExpanded = btn.classList.contains("expanded");

        if (isExpanded) {
          btn.classList.remove("expanded");
          content.classList.remove("expanded");
          savedState[sectionId] = false;
        } else {
          btn.classList.add("expanded");
          content.classList.add("expanded");
          savedState[sectionId] = true;
        }

        localStorage.setItem(storageKey, JSON.stringify(savedState));
      });
    });
  });
</script>
